nginx-managed-cache-example
===========================

Пример, показывающий как использовать возможности кэширования в nginx.

Система
-------

Тестирование и разработка проводились на Debian 7, но и на других Linux
дистрибутивах должно работать. В документации используются пути расположения конфигурационных файлов
актуальные для Debian 7.

Код запускается на связке PHP-FPM + nginx. В качестве базы данных используется sqlite.

Для демонстрации возможностей выбран Yii 1.1.15 и приложение Demo Blog.

Основная идея
-------------

* Для кэширования используется модуль
[fastcgi](http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html).
* Вместо сброса кэша используется обновление кэша. Это сделано с помощью комбинации директив
[fastcgi_cache_bypass](http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_cache_bypass)
и [fastcgi_no_cache](http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_no_cache).
* Ключём кэша выступает URI страницы, то есть часть URL без GET параметров.
* Код настроен так, чтобы везде использовались path-formatted URLs.
* При использовании URL текущей страницы, например для формирования action для тэга form,
необходимо исключать из него параметр для сброса кэша.
* Сброс кэша происходит с помощью HTTP запроса на необходимый URL с добавлением GET параметра.
Запрос выполняется с помощью [curl](http://php.net/manual/en/book.curl.php).
* nginx настроен так, чтобы сброс кэша был возможен только с сервера приложения.
Пользователи не должны иметь возможности сбросить кэш передачей GET параметра.
* Имя GET параметра для сброса кэша следует выбрать таким, чтобы его было трудно угадать.
Это исключит нежелательный показ страницы 403 для пользователей.
* Для отключения кэша нужно устанавливать COOKIE с именем no_cache в 1.
* Для простоты примера кэш настроен только для неавторизованных пользователей. Для авторизованных
пользователей устанавливается COOKIE с именем no_cache в 1.
* Кэш сбрасывается при добавлении или обновлении материала или при добавлении коментария.
* Можно использовать кратковременный сброс кэша для неавторизованного пользователя, чтобы
отобразить ему flash сообщение. Для этого COOKIE устанавливается на несколько секунд.

Установка
---------

Приняты допущения, что приложение запускается от пользователя `webdev` с домашней папкой `/home/webdev`.
Проекты распологаются в папке `/home/webdev/www`. Логи виртуального хоста nginx будут сохраняться
в папку `/home/webdev/www/logs/nginx`. Виртуальный хост будет иметь имя `nginx-managed-cache.local`,
а файлы проекта будут расположены в папке `/home/webdev/www/nginx-managed-cache.local/web`.

Вышеупомянуется папки должны существовать. Пути нужно скорректировать под свою систему.
Создать необходимые папки можно 2мя командами:

```bash
mkdir -p /home/webdev/www/logs/nginx
mkdir -p /home/webdev/www/nginx-managed-cache.local/web
```

* Скачать [архив проекта](https://github.com/xBazilio/nginx-managed-cache-example/archive/master.zip).
* Распаковать архив и скопировать содержимое папки `nginx-managed-cache-example-master` в
`/home/webdev/www/nginx-managed-cache.local/web`
* Настроить PHP-FPM для работы с правами пользователя `webdev`. Для этого в файле
`/etc/php5/fpm/pool.d/www.conf` настроить директивы `user` и `group`.
* nginx будет общаться с PHP-FPM через сокет. Для этого настроить соответствющие директивы:
```
listen = /var/run/php5-fpm.sock
listen.owner = webdev
listen.group = webdev
listen.mode = 0666
```
* Перезапустить PHP-FPM.
* В файл `/etc/nginx/nginx.conf` на сервере приложения добавить строку в секцию `http`:
```
fastcgi_cache_path /var/lib/nginx/cache levels=1:2 keys_zone=one:10m inactive=1d max_size=256m;
```
* Скопировать содержимое папки `nginx_config` проекта в папку `/etc/nginx`
* Сделать ссылку на `/etc/nginx/sites-available/managed-cache-example` в папке
`/etc/nginx/sites-enabled`
* Перезапустить nginx
* Добавить в `/etc/hosts` строку:
```
127.0.0.1 nginx-managed-cache.local
```
* Для генерации sqlite базы данных необходимо выполнить команду находясь в папке `nginx-managed-cache.local/web`:
```bash
php ./app/data/dbgen.php
```
* Открыть в браузере http://nginx-managed-cache.local/

Проверка работы кэширования
---------------------------

В шапке сайта выводится текущая дата и время с секундами. Обновляя страницу можно видеть,
как обновляется время. Если зайти в Блог http://nginx-managed-cache.local/post/index, можно
увидеть, что время не обновляется - работает кэш.

Добавление комментариев к постам обновляет кэш страницы поста.

Если залогиниться - кэширование прекратится. Можно создавать новые посты или редактировать
существующие - будет обновляться кэш первой страницы списка постов и детальные страницы постов.
